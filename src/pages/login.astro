---
import { auth } from "../auth-astro.ts";

let error: string | null = null;

// Check if the user is already logged in and redirect to the homepage if so
if (Astro.locals.session) return Astro.redirect("/");

// Handle form submission to log in the user,
// only used to handle basic form submissions
if (Astro.request.method === "POST") {
	const data = await Astro.request.formData();
	const email = data.get("email")?.toString();
	const password = data.get("password")?.toString();

	if (email && password) {
		try {
			// Sign in with email and password
			const res = await auth.api.signInEmail({
				body: {
					email,
					password,
					callbackURL: "/",
				},
				returnHeaders: true,
			});

			// Redirect to the homepage if successful
			return new Response(null, {
				status: 302,
				headers: {
					"Set-Cookie": res.headers.get("set-cookie") || "",
					Location: res.headers.get("location") || "/",
				},
			});
		} catch (e) {
			error = e?.message ?? "Invalid email or password";
		}
	} else {
		error = "Please fill in all fields";
	}
}
---

<div class="login-container">
    <form method="POST" id="login-form">
        <h1>Login</h1>
        {error &&
                <div class="error">{error}</div>}
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required/>
        </div>
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required/>
        </div>
        <button type="submit">Login</button>
    </form>
</div>
<script>
    /**
     * This is a hydrated example with client side validation.
     * Not available in browsers that do not support JavaScript.
     */
    import {authClient} from "../auth-client.ts";

    const form = document.getElementById('login-form') as HTMLFormElement;
    const errorDiv = document.querySelector('.error');

    if(form){
        form.addEventListener('submit', async (e) => {
            // Prevent default form submission
            e.preventDefault();

            // Hydrated Form Handling
            const formData = new FormData(form);
            try {
                await authClient.signIn.email({
                    email: formData.get('email') || "",
                    password: formData.get('password') || "",
                    callbackURL: '/',
                })
            } catch (error) {
                if (errorDiv) {
                    errorDiv.textContent = 'An error occurred. Please try again.';
                    errorDiv.style.display = 'block';
                }
            }
        });
    }

</script>
<style>
    .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background-color: #f5f5f5;
    }

    #login-form {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 400px;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
    }

    .form-group input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    button {
        width: 100%;
        padding: 0.75rem;
        background-color: #4a90e2;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    button:hover {
        background-color: #357abd;
    }

    .error {
        color: red;
        margin-bottom: 1rem;
        text-align: center;
    }
</style>
