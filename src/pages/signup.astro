---
import { auth } from "../auth-astro.ts";

if (Astro.locals.session) return Astro.redirect("/");

let error: string | null = null;
let success = false;

if (Astro.request.method === "POST") {
	try {
		const data = await Astro.request.formData();
		const name = data.get("name")?.toString();
		const email = data.get("email")?.toString();
		const password = data.get("password")?.toString();

		if (!email || !password || !name) {
			error = "Name, email, and password are required";
		} else {
			await auth.api.signUpEmail({
				body: {
					email,
					password,
					name,
				},
				returnHeaders: true,
			});
			success = true;
		}
	} catch (e) {
		error = e instanceof Error ? e.message : "Unknown error occurred";
	}
}
---

<div class="container">
    <h1>Sign Up</h1>
    {error &&
            <div class="error">{error}</div>}
    {success &&
            <div class="success">Registration successful! You can now <a href="/login">login.</a></div>}

    <form method="POST" class="form" id="signup-form">
        <div class="form-group">
            <label for="name">Name:</label>
            <input id="name" name="name" required>
        </div>
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>
        </div>

        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required>
        </div>

        <button type="submit">Sign Up</button>
    </form>
</div>
<script>
    import {authClient} from "../auth-client.ts";
    const form = document.getElementById('signup-form') as HTMLFormElement;
    const emailInput = document.getElementById('email') as HTMLInputElement;
    const passwordInput = document.getElementById('password') as HTMLInputElement;
    const nameInput = document.getElementById('name') as HTMLInputElement;

    form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log()
        // Reset previous error states
        const errorDiv = document.querySelector('.error');
        if (errorDiv) errorDiv.remove();

        // Basic validation
        if (!emailInput?.value || !passwordInput?.value || !nameInput?.value) {
            const error = document.createElement('div');
            error.className = 'error';
            error.textContent = 'All fields are required';
            form.insertBefore(error, form.firstChild);
            return;
        }

        // Disable form during submission
        const submitButton = form.querySelector('button');
        if (submitButton) {
            submitButton.disabled = true;
            submitButton.textContent = 'Signing up...';
        }

        try {
            const response = await authClient.signUp.email({
                email: emailInput.value,
                password: passwordInput.value,
                name: nameInput.value,
            });
            if (response.success) {
                window.location.reload();
            } else {
                throw new Error('Signup failed');
            }
        } catch (err) {
            const error = document.createElement('div');
            error.className = 'error';
            error.textContent = err instanceof Error ? err.message : 'An error occurred';
            form.insertBefore(error, form.firstChild);
        } finally {
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.textContent = 'Sign Up';
            }
        }
    });
</script>
<style>
    .container {
        max-width: 400px;
        margin: 2rem auto;
        padding: 2rem;
        border: 1px solid #ccc;
        border-radius: 8px;
    }

    .form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    input {
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    button {
        padding: 0.5rem 1rem;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    button:hover {
        background-color: #45a049;
    }

    .error {
        color: red;
        margin-bottom: 1rem;
        padding: 0.5rem;
        background-color: #ffebee;
        border-radius: 4px;
    }

    .success {
        color: green;
        margin-bottom: 1rem;
        padding: 0.5rem;
        background-color: #e8f5e9;
        border-radius: 4px;
    }
</style>
